<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break the Cycle: Ultimate Edition</title>
    <!-- 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- [重要] CSS 檔案連結 -->
    <link rel="stylesheet" href="style.css">
  <style>/* ---
  STYLE.CSS | Break the Cycle: Ultimate Edition
  Designed by Panty Anarchy (because someone had to)
--- */

/* --- 1. THE FOUNDATION: Variables & Global Reset --- */
:root {
    /* Fonts, because even degenerates need to read */
    --font-pixel-en: 'Silkscreen', 'DotGothic16', sans-serif;
    --font-pixel-main: 'DotGothic16', sans-serif;

    /* CUTE MODE PALETTE (Stocking's Diabetic Bullshit) */
    --c-bg: #FFF0F5;
    --c-container-bg: #FFFFFF;
    --c-border: #F9A8D4;
    --c-shadow: #F9A8D4;
    --c-header: #E75480;
    --c-text: #5D4037;
    --c-accent: #FFB6C1;
    --c-button-bg: #E75480;
    --c-button-shadow: #F9A8D4;
    --c-scroll-thumb: #F9A8D4;
    --c-scroll-track: #FFF0F5;
    --c-selection-bg: #F9A8D4;
    --c-selection-text: #5D4037;
    --c-user-msg-bg: #FCE7F3;
    --c-bot-msg-bg: #FDF4F5;
    --c-leaderboard-your-bg: #FCE7F3;
    --c-leaderboard-other-bg: #FFFFFF;
    --c-streak-bar-bg: #FFB6C1;
    --c-streak-bar-fill: #E75480;
    --c-modal-action-bg: #4CAF50; /* A nice, encouraging green */
    --c-modal-action-shadow: #388E3C;
    --bg-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23F9A8D4' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    --character-sprite-bg: #FFF0F5;
}

/* GRUMPY MODE PALETTE (My Fucking Style) */
.grumpy-mode {
    --c-bg: #1A1A2E;
    --c-container-bg: #16213E;
    --c-border: #E94560;
    --c-shadow: #0F3460;
    --c-header: #FF2E63;
    --c-text: #E0E0E0;
    --c-accent: #533483;
    --c-button-bg: #E94560;
    --c-button-shadow: #FF2E63;
    --c-scroll-thumb: #E94560;
    --c-scroll-track: #1A1A2E;
    --c-selection-bg: #E94560;
    --c-selection-text: #FFFFFF;
    --c-user-msg-bg: #0F3460;
    --c-bot-msg-bg: #1e2a4a;
    --c-leaderboard-your-bg: #0F3460;
    --c-leaderboard-other-bg: #16213E;
    --c-streak-bar-bg: #533483;
    --c-streak-bar-fill: #E94560;
    --c-modal-action-bg: #E94560;
    --c-modal-action-shadow: #FF2E63;
    --bg-image: url("data:image/svg+xml,%3Csvg width='44' height='12' viewBox='0 0 44 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 12v-2L0 0v2l20 10zm0-5v-2L0 0v2l20 5zM44 12v-2L24 0v2l20 10zm0-5v-2L24 0v2l20 5z' fill='%23E94560' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
    --character-sprite-bg: #1A1A2E;
}

*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    cursor: var(--cursor-url, url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='48' viewport='0 0 100 100' style='fill:black;font-size:24px;'><text y='50%'>💖</text></svg>") 16 0, auto);
}

body {
    font-family: var(--font-pixel-main);
    background-color: var(--c-bg);
    background-image: var(--bg-image);
    color: var(--c-text);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 1rem;
    transition: background-color 0.25s ease;
    scrollbar-color: var(--c-scroll-thumb) var(--c-scroll-track);
    overflow: hidden; /* No scrollbars on the body */
}

::-webkit-scrollbar { width: 12px; }
::-webkit-scrollbar-track { background: var(--c-scroll-track); }
::-webkit-scrollbar-thumb { background: var(--c-scroll-thumb); border: 2px solid var(--c-scroll-track); border-radius: 6px; }
::-webkit-scrollbar-thumb:hover { background: var(--c-header); }

::selection { background: var(--c-selection-bg); color: var(--c-selection-text); }
::-moz-selection { background: var(--c-selection-bg); color: var(--c-selection-text); }


/* --- 2. LAYOUT & CORE COMPONENTS --- */
.main-container {
    width: 100%;
    max-width: 1200px; /* Wider for the new layout */
    height: 95vh;
    max-height: 800px;
    background: var(--c-container-bg);
    border: 3px dotted var(--c-border);
    padding: 1rem;
    box-shadow: 8px 8px 0px var(--c-shadow);
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
}

.header h1 {
    font-family: var(--font-pixel-en);
    color: var(--c-header);
    font-size: clamp(1.5rem, 4vw, 2rem);
    text-shadow: 2px 2px 0px var(--c-container-bg);
    text-align: center;
    padding: 0.5rem;
    border-bottom: 3px dotted var(--c-border);
    margin-bottom: 1rem;
}

.layout-grid {
    display: grid;
    grid-template-columns: 300px 1fr; /* Sidebar is wider now */
    gap: 1rem;
    flex-grow: 1;
    min-height: 0;
}


/* --- 3. SIDEBAR: Leaderboard & Chat --- */
.sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-height: 0;
}

.sidebar h2 {
    font-family: var(--font-pixel-en);
    font-size: 1.2rem;
    color: var(--c-header);
    background: var(--c-accent);
    padding: 5px;
    text-align: center;
    margin-bottom: 0.5rem;
    flex-shrink: 0;
}

/* LEADERBOARD STYLES (NEW) */
.leaderboard-container {
    flex: 1; /* Takes up half the space */
    display: flex;
    flex-direction: column;
    border: 3px dotted var(--c-border);
    padding: 0.5rem;
    background: rgba(0,0,0,0.05);
    min-height: 0;
}

.leaderboard-list {
    list-style: none;
    overflow-y: auto;
    flex-grow: 1;
}

.leaderboard-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    font-size: 0.9rem;
    border-bottom: 2px dotted var(--c-border);
}
.leaderboard-item:last-child {
    border-bottom: none;
}

.leaderboard-item .rank { font-weight: bold; font-family: var(--font-pixel-en); min-width: 40px; }
.leaderboard-item .name { flex-grow: 1; text-align: left; padding-left: 0.5rem; font-family: var(--font-pixel-en);}
.leaderboard-item .score { font-weight: bold; font-family: var(--font-pixel-en); }

.leaderboard-item.your-score {
    background-color: var(--c-leaderboard-your-bg);
    color: var(--c-header);
    border: 2px solid var(--c-header);
    margin-bottom: 0.5rem;
}

/* CHAT STYLES (MODIFIED) */
.chat-container {
    flex: 1; /* Takes up the other half */
    display: flex;
    flex-direction: column;
    border: 3px dotted var(--c-border);
    padding: 0.5rem;
    background: rgba(0,0,0,0.05);
    min-height: 0;
}

.chat-window { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; }
.chat-window ul { list-style: none; display: flex; flex-direction: column; gap: 0.8rem; }
.chat-window li { padding: 0.6rem; border-radius: 8px; max-width: 90%; opacity: 0; animation: fadeIn 0.5s forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.user-message { background-color: var(--c-user-msg-bg); align-self: flex-end; text-align: right; border-bottom-right-radius: 0; }
.bot-message { background-color: var(--c-bot-msg-bg); align-self: flex-start; border-bottom-left-radius: 0; }
.bot-message::before { content: '🌸 '; }
.grumpy-mode .bot-message::before { content: '🖕 '; }


/* --- 4. MAIN CONTENT & PILL SECTION --- */
.main-content {
    display: flex;
    flex-direction: column;
    min-height: 0;
    padding: 1rem;
    border: 3px dotted var(--c-border);
}

.content-scroll-area { overflow-y: auto; flex-grow: 1; padding-right: 1rem; }
.main-content h2 { font-family: var(--font-pixel-en); font-size: clamp(1.2rem, 3vw, 1.5rem); color: var(--c-header); text-align: center; margin-bottom: 1rem; flex-shrink: 0; }
.card-container { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem; }
.card { width: 48%; padding: 1rem; border: 3px dotted var(--c-border); background: var(--c-container-bg); }
.card h3 { font-family: var(--font-pixel-en); color: var(--c-header); margin-bottom: 0.5rem; }

.pill-section {
    background: var(--c-accent);
    border: 3px dotted var(--c-border);
    padding: 1rem;
    text-align: center;
    margin-top: auto;
    flex-shrink: 0;
}

/* STREAK BAR (NEW) */
.streak-container {
    margin-bottom: 1rem;
}
.streak-bar-wrapper {
    width: 100%;
    height: 20px;
    background-color: var(--c-streak-bar-bg);
    border: 2px solid var(--c-text);
    padding: 2px;
}
.streak-bar {
    width: 0%; /* JS will control this */
    height: 100%;
    background-color: var(--c-streak-bar-fill);
    transition: width 0.5s ease-out;
}
.streak-label {
    margin-top: 0.25rem;
    font-family: var(--font-pixel-en);
    font-size: 0.8rem;
    color: var(--c-text);
    display: block;
}
.grumpy-mode .streak-label { color: var(--c-container-bg); }


#action-input { width: 100%; padding: 0.75rem; font-family: var(--font-pixel-main); border: 3px dotted var(--c-border); background: var(--c-container-bg); font-size: 1rem; color: var(--c-text); appearance: none; border-radius: 0; }
#action-input:focus { outline: 3px dotted var(--c-header); }
#action-input.error { border-color: red; animation: shake 0.5s; }
@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

.premade-pills-container { margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
.premade-pill { font-family: var(--font-pixel-main); font-size: 0.8rem; padding: 0.4rem 0.8rem; background: var(--c-container-bg); border: 2px dotted var(--c-border); cursor: pointer; transition: all 0.2s ease; }
.premade-pill:hover { background: var(--c-header); color: var(--c-container-bg); }

.pill-button { font-family: var(--font-pixel-en); background: var(--c-button-bg); color: var(--c-container-bg); border: 3px solid var(--c-container-bg); box-shadow: 4px 4px 0px var(--c-button-shadow); padding: 0.8rem 1.5rem; font-size: 1.2rem; cursor: pointer; margin-top: 1rem; transition: all 0.2s ease; width: 100%; }
.grumpy-mode .pill-button { text-shadow: 1px 1px 2px black; }
.pill-button:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--c-button-shadow); }
.pill-button:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px var(--c-button-shadow); }


/* --- 5. FIXED ELEMENTS, SETTINGS & PILLGASM --- */
.settings-btn, #hackathon-disclaimer { position: fixed; background: var(--c-container-bg); border: 3px dotted var(--c-border); box-shadow: 4px 4px 0px var(--c-shadow); z-index: 1001; font-family: var(--font-pixel-main); transition: all 0.3s ease; }
.settings-btn { top: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; }
.settings-btn:hover { transform: scale(1.1) rotate(90deg); }
#hackathon-disclaimer { bottom: 20px; left: 20px; padding: 0.5rem 1rem; font-size: 0.9rem; }

.settings-panel { position: fixed; top: 80px; right: 20px; width: 280px; background: var(--c-container-bg); border: 3px dotted var(--c-border); box-shadow: 8px 8px 0px var(--c-shadow); padding: 1rem; z-index: 1000; opacity: 0; transform: translateY(-20px); pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; }
.settings-panel.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
.settings-panel h3 { font-family: var(--font-pixel-en); color: var(--c-header); margin-bottom: 1rem; border-bottom: 2px dotted var(--c-border); padding-bottom: 0.5rem; }
.setting-group { margin-bottom: 1rem; }
.setting-group label { font-weight: bold; display: block; margin-bottom: 0.5rem; }
.switcher { display: flex; gap: 0.5rem; }
.switcher button { flex: 1; font-family: var(--font-pixel-main); padding: 0.5rem; border: 2px dotted var(--c-border); background: var(--c-accent); cursor: pointer; }
.switcher button.active { background: var(--c-header); color: var(--c-container-bg); font-weight: bold; }
.settings-panel-button { width: 100%; margin-top: 0.5rem; font-family: var(--font-pixel-en); padding: 0.5rem; background: var(--c-accent); border: 2px dotted var(--c-border); cursor: pointer; font-size: 1rem; }
.settings-panel-button:hover { background: var(--c-header); color: var(--c-container-bg); }

.collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; max-height: 150px; overflow-y: auto; padding: 5px; background: rgba(0,0,0,0.05); }
.collection-item { border: 2px dotted var(--c-border); aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 1.5rem; background: var(--c-container-bg); cursor: pointer; transition: all 0.2s; position: relative; }
.collection-item.locked { background: #888; color: #555; cursor: not-allowed; opacity: 0.5; }
.collection-item.locked .item-name { color: #555; }
.collection-item.unlocked:hover { transform: scale(1.1); background: var(--c-accent); }
.item-icon { line-height: 1; }
.item-name { font-size: 0.6rem; color: var(--c-text); position: absolute; bottom: 2px; left: 0; right: 0; }

.confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
.confetti-piece { position: absolute; top: -5vh; opacity: 0; font-size: 20px; }

/* PILLGASM EFFECTS (NEW) */
.pillgasm-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: white;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
}
.pillgasm-overlay.active {
    animation: flashbang 0.5s ease-out;
}
@keyframes flashbang {
    0% { opacity: 0.8; }
    100% { opacity: 0; }
}
.main-container.shake {
    animation: screen-shake 0.4s;
}
@keyframes screen-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
}
body.climax-mode {
    animation: pulse-bg 1s infinite alternate;
}
@keyframes pulse-bg {
    from { background-color: var(--c-bg); }
    to { background-color: var(--c-header); }
}
.settings-btn, #hackathon-disclaimer { 
    position: fixed; 
    background: var(--c-container-bg); 
    border: 3px dotted var(--c-border); 
    box-shadow: 4px 4px 0px var(--c-shadow); 
    z-index: 1001; 
    font-family: var(--font-pixel-main); 
    transition: all 0.3s ease; 
    /* Make this shit clickable, duh */
    cursor: pointer; 
}
.settings-btn { top: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; }
.settings-btn:hover { transform: scale(1.1) rotate(90deg); }
#hackathon-disclaimer { bottom: 20px; left: 20px; padding: 0.5rem 1rem; font-size: 0.9rem; }
/* Add this pathetic hover effect so you know it does something */
#hackathon-disclaimer:hover {
    transform: translateY(-2px);
    box-shadow: 6px 6px 0px var(--c-shadow);
}


.settings-panel { position: fixed; top: 80px; right: 20px; width: 280px; background: var(--c-container-bg); border: 3px dotted var(--c-border); box-shadow: 8px 8px 0px var(--c-shadow); padding: 1rem; z-index: 1000; opacity: 0; transform: translateY(-20px); pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; }
.settings-panel.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
.settings-panel h3 { font-family: var(--font-pixel-en); color: var(--c-header); margin-bottom: 1rem; border-bottom: 2px dotted var(--c-border); padding-bottom: 0.5rem; }
.setting-group { margin-bottom: 1rem; }
.setting-group label { font-weight: bold; display: block; margin-bottom: 0.5rem; }
.switcher { display: flex; gap: 0.5rem; }

/* HERE, YOU LAZY FUCK! FIX YOUR BUTTONS! */
.switcher button, .settings-panel-button {
    flex: 1; 
    font-family: var(--font-pixel-main); 
    padding: 0.5rem; 
    border: 2px dotted var(--c-border); 
    background: var(--c-accent); 
    cursor: pointer;
    transition: all 0.15s ease-out; /* Add some damn feedback */
}

.switcher button.active, .settings-panel-button:hover { 
    background: var(--c-header); 
    color: var(--c-container-bg); 
    font-weight: bold; 
    transform: translateY(-2px); /* Make it POP, idiot */
}

.switcher button:active, .settings-panel-button:active {
    transform: translateY(1px); /* PUSH IT! */
}


/* --- 6. MODALS --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 2000; }
.modal-overlay.visible { opacity: 1; pointer-events: auto; }
.modal-content { background: var(--c-container-bg); border: 3px dotted var(--c-border); box-shadow: 8px 8px 0px var(--c-shadow); padding: 2rem; width: 90%; max-width: 500px; text-align: center; transform: scale(0.8); transition: transform 0.3s ease; }
.modal-overlay.visible .modal-content { transform: scale(1); }
.modal-content h2 { font-family: var(--font-pixel-en); color: var(--c-header); font-size: 1.8rem; margin-bottom: 1rem; }
.modal-content p { margin-bottom: 1.5rem; font-size: 1.1rem; line-height: 1.5; }

.modal-close-btn, .modal-action-btn {
    font-family: var(--font-pixel-en);
    border: 2px dotted var(--c-border);
    padding: 0.7rem 1.5rem;
    cursor: pointer;
    font-size: 1rem;
    margin: 0.5rem;
    transition: all 0.2s ease;
}
.modal-close-btn { background: var(--c-accent); }
.modal-action-btn { background: var(--c-modal-action-bg); color: white; box-shadow: 4px 4px 0px var(--c-modal-action-shadow); }
.modal-action-btn:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--c-modal-action-shadow); }
.modal-action-btn:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px var(--c-modal-action-shadow); }

/* Diagnosis Modal Specifics */
.diagnosis-stats { display: flex; justify-content: space-around; margin-bottom: 1.5rem; text-align: center; }
.stat h3 { font-family: var(--font-pixel-en); font-size: 2.5rem; color: var(--c-header); }
.stat p { font-size: 0.9rem; margin: 0; }
#diagnosis-summary { font-style: italic; background: rgba(0,0,0,0.05); padding: 10px; border: 2px dotted var(--c-border); }

/* Character Modal (NEW) */
.modal-content.character-modal {
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 600px;
    padding: 0;
    overflow: hidden; /* Important for containing the image */
}
#character-sprite-img {
    width: 100%;
    height: auto;
    background-color: var(--character-sprite-bg);
    border-bottom: 3px dotted var(--c-border);
}
.character-dialogue {
    padding: 1.5rem;
    width: 100%;
}


/* --- 7. RESPONSIVE DESIGN --- */
@media (max-width: 820px) {
    body { padding: 0; }
    .main-container {
        height: 100vh;
        max-height: none;
        max-width: 100%;
        border: none;
        box-shadow: none;
        padding: 0.5rem;
    }
    .layout-grid {
        grid-template-columns: 1fr;
        grid-template-rows: 250px 1fr; /* Sidebar gets fixed height */
    }
    .sidebar { order: 2; flex-direction: row; } /* Side-by-side on mobile */
    .leaderboard-container, .chat-container { flex: 1; }

    .main-content { order: 1; padding: 0.5rem; }
    .card-container { flex-direction: column; align-items: center; }
    .card { width: 95%; }

    #hackathon-disclaimer { font-size: 0.8rem; padding: 0.4rem 0.8rem; bottom: 10px; left: 10px; }
    .settings-panel { right: 10px; left: 10px; width: auto; }
}</style>
</head>
  
<body>

    <!-- 固定不動的 UI 元素 -->
    <div class="settings-btn" id="settings-btn">⚙️</div>
    <div id="hackathon-disclaimer">Hackathon Project (?)</div>
    <div class="confetti-container" id="confetti-container"></div>
    <div class="pillgasm-overlay" id="pillgasm-overlay"></div> <!-- Pillgasm 閃爍/震動效果用的覆蓋層 -->

    <!-- 設定面板 (Settings Panel) - 給我用這個修正版！ -->
<div class="settings-panel" id="settings-panel">
    <h3 data-i18n-key="settingsTitle">設定</h3>
    
    <!-- 模式切換 -->
    <div class="setting-group">
        <label data-i18n-key="modeLabel">模式切換</label>
        <div class="switcher" id="mode-switcher">
            <button id="mode-cute" class="active" data-i18n-key="modeCute">可愛天使</button>
            <button id="mode-grumpy" data-i18n-key="modeGrumpy">暴躁天使</button>
        </div>
    </div>
    
    <!-- 語言切換 -->
    <div class="setting-group">
        <label data-i18n-key="langLabel">語言</label>
        <div class="switcher" id="lang-switcher">
            <button id="lang-zh" class="active">繁體中文</button>
            <button id="lang-en">English</button>
        </div>
    </div>

    <!-- 秘密菓子櫃 (Collection) -->
    <div class="setting-group">
        <label data-i18n-key="stashTitle">秘密菓子櫃</label>
        <div class="collection-grid" id="collection-grid">
            <!-- 獎勵會由 JS 動態生成於此 -->
        </div>
    </div>

    <!-- 天使的診斷書按鈕 -->
    <div class="setting-group">
         <button class="settings-panel-button" id="diagnosis-btn" data-i18n-key="diagnosisBtn">天使的診斷書</button>
    </div>
  <div class="setting-group">
            <button class="settings-panel-button" id="reset-style-btn" data-i18n-key="resetStyleBtn">重置樣式</button>
        </div>
  
</div>
    
    <!-- 主要 App 結構 (Main Container) -->
    <div class="main-container">
        <header class="header">
            <h1 data-i18n-key="mainTitle">迴圈終結者 急救站</h1>
        </header>

        <div class="layout-grid">
            <!-- 左側邊欄 (Sidebar) -->
            <aside class="sidebar">
                <!-- [PANTY'S UPGRADE] 排行榜 (Leaderboard) -->
                <div class="leaderboard-container">
                    <h2 data-i18n-key="leaderboardTitle">墮落者排行</h2>
                    <div class="leaderboard-item your-score" id="your-score-display">
                        <span class="rank">YOU</span>
                        <span class="name" data-i18n-key="leaderboardYou">你</span>
                        <span class="score">0</span>
                    </div>
                    <ul class="leaderboard-list" id="leaderboard-list">
                        <!-- 假掰的對手會由 JS 動態生成於此 -->
                    </ul>
                </div>
                
                <!-- 聊天應援團 (Cheer Squad) -->
                <div class="chat-container">
                    <h2 data-i18n-key="cheerTitle"></h2>
                    <div class="chat-window" id="chat-window"><ul></ul></div>
                </div>
            </aside>
            
            <!-- 主要內容區塊 (Main Content) -->
            <main class="main-content">
                <div class="content-scroll-area">
                    <h2 data-i18n-key="mainSubtitle"></h2>
                    <div class="card-container">
                        <div class="card"><h3 data-i18n-key="card1Title"></h3><p data-i18n-key="card1Text"></p></div>
                        <div class="card"><h3 data-i18n-key="card2Title"></h3><p data-i18n-key="card2Text"></p></div>
                    </div>
                </div>

                <!-- 行動藥丸區塊 (Pill Section) -->
                <form class="pill-section" id="action-form">
                    <!-- [PANTY'S UPGRADE] 連擊進度條 (Streak Bar) -->
                    <div class="streak-container">
                        <div class="streak-bar-wrapper">
                            <div class="streak-bar" id="streak-bar"></div>
                        </div>
                        <span class="streak-label" id="streak-label">DAILY STREAK: 0/5</span>
                    </div>

                    <h3 data-i18n-key="pillTitle"></h3>
                    <p data-i18n-key="pillText"></p>
                    <input type="text" id="action-input" autocomplete="off">
                    <div class="premade-pills-container" id="premade-pills-container"></div>
                    <button type="submit" class="pill-button" id="action-button" data-i18n-key="pillBtn"></button>
                </form>
            </main>
        </div>
    </div>

    <!-- 各式各樣的彈出視窗 (Modals) -->

    <!-- 1. 歡迎視窗 -->
    <div class="modal-overlay" id="welcome-modal-overlay">
        <div class="modal-content"><h2 data-i18n-key="modalTitle"></h2><p data-i18n-key="modalText"></p><button class="modal-close-btn" data-i18n-key="modalBtn"></button></div>
    </div>

    <!-- 2. 獎勵解鎖視窗 -->
    <div class="modal-overlay" id="reward-modal-overlay">
        <div class="modal-content"><h2 data-i18n-key="rewardModalTitle"></h2><p id="reward-modal-text"></p><button class="modal-close-btn" data-i18n-key="rewardModalBtn"></button></div>
    </div>

    <!-- 3. 診斷書視窗 -->
    <div class="modal-overlay" id="diagnosis-modal-overlay">
        <div class="modal-content">
            <h2 data-i18n-key="diagnosisModalTitle"></h2>
            <div class="diagnosis-stats">
                <div class="stat"><h3 id="diagnosis-cute-pills">0</h3><p data-i18n-key="diagnosisCutePillLabel"></p></div>
                <div class="stat"><h3 id="diagnosis-grumpy-pills">0</h3><p data-i18n-key="diagnosisGrumpyPillLabel"></p></div>
            </div>
            <p id="diagnosis-summary"></p>
            <button class="modal-close-btn" data-i18n-key="diagnosisModalBtn"></button>
        </div>
    </div>

    <!-- 4. [PANTY'S UPGRADE] 炫耀視窗 (Brag Modal) -->
    <div class="modal-overlay" id="brag-modal-overlay">
        <div class="modal-content">
            <h2 data-i18n-key="bragModalTitle">🔥 PILLGASM! 🔥</h2>
            <p data-i18n-key="bragModalText"></p>
            <button class="modal-action-btn" id="brag-btn" data-i18n-key="bragBtn">炫耀一下！</button>
            <button class="modal-close-btn" data-i18n-key="bragCloseBtn">算了</button>
        </div>
    </div>
    
    <!-- 5. [YOUR UPGRADE] 角色對話視窗 (Pointless Click Modal) -->
    <div class="modal-overlay" id="pointless-click-modal-overlay">
        <div class="modal-content character-modal">
            <img src="https://placehold.co/400x300/E75480/FFF?text=ANGEL" alt="Character Sprite" id="character-sprite-img">
            <div class="character-dialogue">
                <h2 id="character-dialogue-title"></h2>
                <p id="character-dialogue-text"></p>
                <button class="modal-close-btn" id="pointless-click-close-btn"></button>
            </div>
        </div>
    </div>
    <!-- 6. [NEW!] 訊息視窗 (Message Modal for Rewards) -->
    <div class="modal-overlay" id="message-modal-overlay">
        <div class="modal-content">
            <h2 data-i18n-key="messageModalTitle">天使的私信</h2>
            <p id="message-modal-text"></p>
            <button class="modal-close-btn" data-i18n-key="messageModalBtn">知道了啦</button>
        </div>
    </div>

    <!-- 7. [NEW!] Hackathon 資訊視窗 (Hackathon Info Modal) -->
    <div class="modal-overlay" id="hackathon-info-modal-overlay">
        <div class="modal-content">
            <h2>關於這個垃圾 Hackathon</h2>
            <p>對，這就是那個你找不到主辦單位的垃圾比賽。評審？大概就是 "Silicon Hack Club" 自己吧。獎品？一張他媽的電子證書。但你聽好了，廢物！就算是在垃圾堆裡，你也要當最亮的那坨屎！這不是為了他們，是為了證明你不是只會抱怨的軟腳蝦！現在滾回去繼續！</p>
            <button class="modal-close-btn">嘖，知道了！</button>
        </div>
    </div>
    
    <!-- [重要] JavaScript 檔案連結 (放在 body 結尾前) -->
    <script src="script.js"></script>
  <script>/* ---
  SCRIPT.JS | Break the Cycle: Ultimate Edition
  The soul of the machine. Let's get wild.
--- */

document.addEventListener('DOMContentLoaded', () => {
    // --- 1. DOM ELEMENTS & CONSTANTS ---
    // Grab every single goddamn thing we need to control.
    const allI18nElements = document.querySelectorAll('[data-i18n-key]');
    const body = document.body;

    // Core App
    const mainContainer = document.querySelector('.main-container');
    const chatWindow = document.getElementById('chat-window');
    const chatList = chatWindow.querySelector('ul');
    const actionForm = document.getElementById('action-form');
    const actionInput = document.getElementById('action-input');
    const actionButton = document.getElementById('action-button');
    const premadePillsContainer = document.getElementById('premade-pills-container');

    // Settings & Collection
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const collectionGrid = document.getElementById('collection-grid');
    const diagnosisBtn = document.getElementById('diagnosis-btn');

    // New Panty Features
    const leaderboardList = document.getElementById('leaderboard-list');
    const yourScoreDisplay = document.getElementById('your-score-display');
    const streakBar = document.getElementById('streak-bar');
    const streakLabel = document.getElementById('streak-label');
    const pillgasmOverlay = document.getElementById('pillgasm-overlay');

    // Modals
    const welcomeModal = document.getElementById('welcome-modal-overlay');
    const rewardModal = document.getElementById('reward-modal-overlay');
    const diagnosisModal = document.getElementById('diagnosis-modal-overlay');
    const bragModal = document.getElementById('brag-modal-overlay');
    const pointlessClickModal = document.getElementById('pointless-click-modal-overlay');
    const bragBtn = document.getElementById('brag-btn');
const resetStyleBtn = document.getElementById('reset-style-btn');
  
    // ADDED THESE BECAUSE YOU'RE HELPLESS
    const messageModal = document.getElementById('message-modal-overlay');
    const messageModalText = document.getElementById('message-modal-text');
    const hackathonDisclaimer = document.getElementById('hackathon-disclaimer');
    const hackathonInfoModal = document.getElementById('hackathon-info-modal-overlay');


    // --- 2. STATE MANAGEMENT ---
    // The app's entire memory. Don't fuck with this unless you know what you're doing.
    const STATE_DEFAULTS = {
        lang: 'zh-Hant',
        mode: 'cute',
        pillCount_total: 0,
        pillCount_cute: 0,
        pillCount_grumpy: 0,
        unlockedRewards: JSON.stringify([]),
        appliedCursor: null,
        appliedBackground: null,
        highscore: 0,
        dailyStreak: 0,
        lastPillTimestamp: 0,
        pointlessClickCount: 0,
    };
    let state = {};

    // --- 3. DATABASES (Rewards & Translations) ---
    // All the unlockable goodies.
    const rewards = {
        3:  { id: 'cursor_strawberry', type: 'cursor', value: '🍓', nameKey: 'rewardNameCursorStrawberry' },
        7:  { id: 'cursor_skull', type: 'cursor', value: '💀', nameKey: 'rewardNameCursorSkull' },
        12: { id: 'bg_hearts', type: 'background', value: 'hearts', nameKey: 'rewardNameBgHearts' },
        20: { id: 'bg_hellfire', type: 'background', value: 'hellfire', nameKey: 'rewardNameBgHellfire' },
        30: { id: 'msg_secret_cute', type: 'message', messageKey: 'rewardMsgSecretCute', nameKey: 'rewardNameSecretCute' },
        45: { id: 'msg_secret_grumpy', type: 'message', messageKey: 'rewardMsgSecretGrumpy', nameKey: 'rewardNameSecretGrumpy' }
    };

    const backgroundStyles = {
        hearts: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'%3E%3Cpath d='M14 2c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6s6-2.69 6-6c0-3.31-2.69-6-6-6zm0 14c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6s6-2.69 6-6c0-3.31-2.69-6-6-6z' fill='%23F9A8D4' fill-opacity='0.1'/%3E%3C/svg%3E")`,
        hellfire: `url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23E94560' fill-opacity='0.1'%3E%3Cpath d='M80 0v20L40 60 0 20V0h80zM40 40L0 0h80L40 40z'/%3E%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`
    };

    // The entire fucking dictionary for the app.
    const translations = {
        'zh-Hant': {
            'cute': {
                'resetStyleBtn': '✨ 恢復原狀 ✨','mainTitle': '💖 行動派小天使 急救站 💖', 'cheerTitle': '✨ 你的專屬應援團 ✨', 'mainSubtitle': '你不是有問題... 只是需要一顆小小的藥丸！', 'card1Title': '分析癱瘓...', 'card1Text': '想太多做得少，害怕不完美所以乾脆不動...我知道啦！', 'card2Title': '創傷迴圈...', 'card2Text': '腦袋一直重播黑歷史，覺得努力也沒用...真的辛苦你了！', 'pillTitle': '💊 神聖行動藥丸 💊', 'pillText': '寫下一件小到不可能失敗的事，或選一個下面的建議吧！', 'pillBtn': '服用我的「行動藥丸」！', 'inputPlaceholder': '例如: 喝一杯水 / 摸一下貓', 'inputError': '不可以空白喔！寫點什麼嘛！', 'modalTitle': '嘿！就是你！', 'modalText': '我知道你很累，也知道你的腦袋快爆炸了。但你今天點進來了，這就代表你超棒的。準備好終結那個討厭的迴圈了嗎？', 'modalBtn': '準備好了！(⁄ ⁄>⁄ ⁄<⁄ ⁄)', 'settingsTitle': '設定', 'modeLabel': '模式切換', 'modeCute': '可愛天使', 'modeGrumpy': '暴躁天使', 'langLabel': '語言', 'initialCheer': '有什麼煩惱嗎？寫下來，我們一起把它變成行動！', 'cheers': ["你按下了按鈕！天啊！", "這一步超重要的！你做到了！", "你看！行動沒有那麼可怕！", "我就知道你可以的！✨", "太棒了！你正在改寫歷史！", "你比全世界99%的人都勇敢！", "給你一個大大的抱抱！💖", "現在，沒有什麼能阻止你了！", "你是最棒的！不接受反駁！"], 'premadePills': ['深呼吸一次', '喝一小口水', '伸個懶腰', '微笑一秒'], 'stashTitle': '秘密菓子櫃', 'diagnosisBtn': '天使的診斷書', 'rewardModalTitle': '✨ 解鎖新獎勵！ ✨', 'rewardModalBtn': '太棒了！', 'diagnosisModalTitle': '天使的診斷書', 'diagnosisCutePillLabel': '可愛藥丸', 'diagnosisGrumpyPillLabel': '暴躁藥丸', 'diagnosisSummaryDefault': '還沒有足夠的數據來診斷你喔，快去吃藥丸吧！', 'diagnosisSummaryCute': '診斷結果：重度糖分依賴症。看來你很享受被捧在手心的感覺呢，小寶貝。', 'diagnosisSummaryGrumpy': '診斷結果：深度刺激渴望症。嗯？被罵也很舒服嗎？真是個小壞蛋。', 'diagnosisSummaryMixed': '診斷結果：糖分與羞辱混合依賴症候群。甜言蜜語和嚴厲的鞭策你都需要呢...真是個貪心的孩子。', 'diagnosisModalBtn': '我明白了', 'rewardNameCursorStrawberry': '草莓游標', 'rewardNameCursorSkull': '骷髏游標', 'rewardNameBgHearts': '愛心背景', 'rewardNameBgHellfire': '地獄火背景', 'rewardNameSecretCute': '天使的私語', 'rewardNameSecretGrumpy': '惡魔的低語', 'rewardMsgSecretCute': '悄悄告訴你...你努力的樣子，其實有點可愛。', 'rewardMsgSecretGrumpy': '喂，聽好了...你比你想像的還要不廢物，不准再妄自菲薄了。',
                'leaderboardTitle': '優等生排行', 'leaderboardYou': '你', 'bragModalTitle': '✨ 連擊達成！ ✨', 'bragModalText': '太棒了！你達成了 5 連擊，要不要跟朋友分享這個好消息呀？', 'bragBtn': '分享喜悅！', 'bragCloseBtn': '保持低調', 'twitterTextCute': '💖 耶！我在 Break the Cycle 達成了 5 日連擊，感覺超棒的！你也一起來吧！ #BreakTheCycle #正能量',
                'pointlessClickTitleCute': '那個...', 'pointlessClickTextCute': '嘿...你還好嗎？一直點按鈕是沒用的喔，要在上面的框框裡寫點東西才行。我相信你做得到的！', 'pointlessClickBtnCute': '我知道了',
                'messageModalTitle': '✨ 天使的私信 ✨', 'messageModalBtn': '收到囉！💖'
            },
            'grumpy': {
               'resetStyleBtn': '🖕 全部滾蛋 🖕', 'mainTitle': '🖕 暴躁天使 精神急救站 🖕', 'cheerTitle': '🖕 踹你屁股的應援團 🖕', 'mainSubtitle': '你他媽的不是有問題... 你是欠一顆藥丸！', 'card1Title': '分析癱瘓，哈？', 'card1Text': '想太多做得少？害怕不完美？你是在寫論文還是在過人生？', 'card2Title': '創傷迴圈，嗯？', 'card2Text': '腦袋一直重播黑歷史？你是DJ嗎？給我換一首！', 'pillTitle': '💊 給我吞下這顆該死的藥丸 💊', 'pillText': '寫點屁話，或者直接點下面的，然後按下按鈕。現在。', 'pillBtn': '服用這顆該死的藥丸！', 'inputPlaceholder': '例如: 呼吸 / 眨眼 / 停止抱怨', 'inputError': '空白？你腦子也是空白的嗎？寫！', 'modalTitle': '喂！看這裡！', 'modalText': '我知道你很累，腦袋快炸了。很好。這代表你還活著。現在，準備好終結你那該死的、自怨自艾的廣播劇了嗎？', 'modalBtn': '早就該他媽的準備好了！', 'settingsTitle': '設定啦！', 'modeLabel': '人格切換', 'modeCute': '裝可愛', 'modeGrumpy': '說實話', 'langLabel': '語言', 'initialCheer': '有什麼屁事？寫下來，然後滾去做。', 'cheers': ["你終於按了？花了多久？", "很好。不要搞砸了。", "行動而已，有那麼可怕嗎？", "幹得不錯。別驕傲。", "你正在改寫你那該死的悲劇。", "你比你想像的還要不廢物。", "給你一個...不情願的肯定。", "現在，滾去做事！", "你是最不爛的！暫時！"], 'premadePills': ['別再抱怨了', '滾去洗澡', '回那個訊息', '坐直'], 'stashTitle': '戰利品收藏', 'diagnosisBtn': '給你的診斷', 'rewardModalTitle': '🖕 拿到新東西了，哼 🖕', 'rewardModalBtn': '知道了啦！', 'diagnosisModalTitle': '你的診斷書', 'diagnosisCutePillLabel': '裝可愛藥丸', 'diagnosisGrumpyPillLabel': '老實說藥丸', 'diagnosisSummaryDefault': '數據不夠。你以為我是算命的嗎？滾去吃藥丸。', 'diagnosisSummaryCute': '診斷結果：你就是個需要人哄的軟腳蝦。可悲。', 'diagnosisSummaryGrumpy': '診斷結果：抖M傾向。越罵越爽是吧？變態。', 'diagnosisSummaryMixed': '診斷結果：混亂中立的麻煩鬼。一下要糖一下要鞭子，你以為你是誰啊？', 'diagnosisModalBtn': '嘖。', 'rewardNameCursorStrawberry': '噁心草莓', 'rewardNameCursorSkull': '帥氣骷髏', 'rewardNameBgHearts': '娘炮愛心', 'rewardNameBgHellfire': '地獄之火', 'rewardNameSecretCute': '噁心的私語', 'rewardNameSecretGrumpy': '惡魔的真理', 'rewardMsgSecretCute': '我...我才不是覺得你可愛呢，笨蛋！', 'rewardMsgSecretGrumpy': '聽好了，廢物。別死在我看不見的地方。就這樣。',
                'leaderboardTitle': '墮落者排行', 'leaderboardYou': '你這個廢物', 'bragModalTitle': '🔥 PILLGASM! 🔥', 'bragModalText': '哈！你終於連續 5 天沒當個懶蟲了。要去跟全世界炫耀你這點微不足道的成就嗎？', 'bragBtn': '去嗆爆他們！', 'bragCloseBtn': '沒種', 'twitterTextGrumpy': '🔥 剛在 Break the Cycle 達成了一次 PILLGASM。你們這些懶鬼最好跟上我的腳步。 #BreakTheCycle #NotALazyAssAnymore',
                'pointlessClickTitleGrumpy': '你有什麼毛病？', 'pointlessClickTextGrumpy': '喂，你是瞎了還是怎樣？輸入框在上面！一直戳按鈕是在幫它馬殺雞嗎？快給老娘寫點東西進去！', 'pointlessClickBtnGrumpy': '嘖，知道了！',
                'messageModalTitle': '🖕 惡魔的命令 🖕', 'messageModalBtn': '嘖，知道了！'
            }
        },
               'en': {
            'cute': {
                'mainTitle': '💖 Action Angel First-Aid Station 💖', 'cheerTitle': '✨ Your Personal Cheer Squad ✨', 'mainSubtitle': 'You\'re not broken... you just need a little pill!', 'card1Title': 'Analysis Paralysis...', 'card1Text': 'Thinking too much, doing too little, afraid of not being perfect... I get it!', 'card2Title': 'Trauma Loops...', 'card2Text': 'Replaying the past, feeling like effort is pointless... You\'ve been through a lot!', 'pillTitle': '💊 The Sacred Action Pill 💊', 'pillText': 'Write down one tiny thing you can\'t fail at, or pick a suggestion below!', 'pillBtn': 'Take my Action Pill!', 'inputPlaceholder': 'e.g., Drink a sip of water / Pet the cat', 'inputError': 'Don\'t leave it blank! C\'mon!', 'modalTitle': 'Hey! You!', 'modalText': 'I know you\'re tired, and I know your brain is fried. But you showed up today, and that makes you amazing. Ready to break the cycle?', 'modalBtn': 'I\'m so ready! (⁄ ⁄>⁄ ⁄<⁄ ⁄)', 'settingsTitle': 'Settings', 'modeLabel': 'Switch Mode', 'modeCute': 'Cute Angel', 'modeGrumpy': 'Grumpy Angel', 'langLabel': 'Language', 'initialCheer': 'What\'s on your mind? Let\'s turn it into an action!', 'cheers': ["You pressed the button! Oh my gosh!", "That first step is HUGE! You did it!", "See? Action isn\'t so scary!", "I knew you could do it! ✨", "Amazing! You\'re rewriting your story!", "You\'re braver than 99% of people!", "Here\'s a big hug! 💖", "Nothing can stop you now!", "You\'re the best! No arguments!"], 'premadePills': ['Take one deep breath', 'Drink a sip of water', 'Stretch for a second', 'Smile for a second'], 'stashTitle': 'Secret Stash', 'diagnosisBtn': 'Angel\'s Diagnosis', 'rewardModalTitle': '✨ New Reward Unlocked! ✨', 'rewardModalBtn': 'Awesome!', 'diagnosisModalTitle': 'Angel\'s Diagnosis', 'diagnosisCutePillLabel': 'Cute Pills', 'diagnosisGrumpyPillLabel': 'Grumpy Pills', 'diagnosisSummaryDefault': 'Not enough data to diagnose you yet. Go take some pills!', 'diagnosisSummaryCute': 'Diagnosis: Severe Sugar Dependency. Looks like you enjoy being pampered, sweetie.', 'diagnosisSummaryGrumpy': 'Diagnosis: Deep-seated Craving for Stimulation. Getting yelled at feels good, huh? You little rascal.', 'diagnosisSummaryMixed': 'Diagnosis: Sweet & Sour Syndrome. You need both honeyed words and a firm whip... such a greedy child.', 'diagnosisModalBtn': 'I understand', 'rewardNameCursorStrawberry': 'Strawberry Cursor', 'rewardNameCursorSkull': 'Skull Cursor', 'rewardNameBgHearts': 'Hearts Background', 'rewardNameBgHellfire': 'Hellfire Background', 'rewardNameSecretCute': 'Angel\'s Whisper', 'rewardNameSecretGrumpy': 'Demon\'s Murmur', 'rewardMsgSecretCute': 'Just between us... you\'re kinda cute when you try hard.', 'rewardMsgSecretGrumpy': 'Hey, listen up... you\'re less of a screw-up than you think. Don\'t you dare forget it.',
                'leaderboardTitle': 'Top Students', 'leaderboardYou': 'You', 'bragModalTitle': '✨ Streak Complete! ✨', 'bragModalText': 'Incredible! You hit a 5-day streak. Wanna share the good news with your friends?', 'bragBtn': 'Share the Joy!', 'bragCloseBtn': 'Stay Humble', 'twitterTextCute': '💖 Yay! I just hit a 5-day streak in Break the Cycle and I feel amazing! You should join me! #BreakTheCycle #PositiveVibes',
                'pointlessClickTitleCute': 'Um...', 'pointlessClickTextCute': 'Hey... you okay? Just clicking the button won\'t work. You have to type something in the box above. I believe in you!', 'pointlessClickBtnCute': 'Oh, right!',
                'messageModalTitle': '✨ A Letter from an Angel ✨', 'messageModalBtn': 'Got it! 💖'
            },
            'grumpy': {
                'mainTitle': '🖕 Grumpy Angel Mental E.R. 🖕', 'cheerTitle': '🖕 Your Kick-in-the-Ass Squad 🖕', 'mainSubtitle': 'You\'re not fucking broken... you\'re just overdue for a pill!', 'card1Title': 'Analysis Paralysis, huh?', 'card1Text': 'Thinking too much, doing too little? Scared of not being perfect? Are you writing a thesis or living a life?', 'card2Title': 'Trauma Loops, really?', 'card2Text': 'Replaying your failures? What are you, a DJ? Change the damn track!', 'pillTitle': '💊 Swallow the Damn Pill 💊', 'pillText': 'Write some crap, or click one of the things below. Then hit the button. Now.', 'pillBtn': 'Take the damn pill!', 'inputPlaceholder': 'e.g., Breathe / Blink / Stop whining', 'inputError': 'Blank? Is your brain blank, too? WRITE!', 'modalTitle': 'HEY! EYES HERE!', 'modalText': 'I know you\'re tired. I know your brain wants to explode. Good. It means you\'re alive. Now, are you ready to end your pathetic, self-pitying radio drama?', 'modalBtn': 'FUCKING READY!', 'settingsTitle': 'Settings!', 'modeLabel': 'Personality Switch', 'modeCute': 'Be Cute', 'modeGrumpy': 'Be Honest', 'langLabel': 'Language', 'initialCheer': 'What\'s your problem? Write it down, then go fucking do it.', 'cheers': ["You finally pressed it? What took so long?", "Good. Don't screw it up.", "It's just an action. Was that so hard?", "Decent work. Don't get cocky.", "You're rewriting your shitty tragedy.", "You're less of a screw-up than you think.", "Here's a... reluctant nod of approval.", "Now get the hell to work!", "You\'re the least pathetic one! For now!"], 'premadePills': ['Stop complaining', 'Go take a shower', 'Reply to that text', 'Sit up straight'], 'stashTitle': 'Trophy Case', 'diagnosisBtn': 'Your Diagnosis', 'rewardModalTitle': '🖕 Got a new thing. Whatever. 🖕', 'rewardModalBtn': 'Yeah, yeah.', 'diagnosisModalTitle': 'Your Diagnosis', 'diagnosisCutePillLabel': 'Cute Pills', 'diagnosisGrumpyPillLabel': 'Honesty Pills', 'diagnosisSummaryDefault': 'Not enough data. What do I look like, a psychic? Go take your pills.', 'diagnosisSummaryCute': 'Diagnosis: You\'re a goddamn baby who needs to be coddled. Pathetic.', 'diagnosisSummaryGrumpy': 'Diagnosis: Certified Masochist. You get off on this, don\'t you? You freak.', 'diagnosisSummaryMixed': 'Diagnosis: Chaotic Neutral Pain-in-the-Ass. You want candy and a whip at the same time. Who the hell do you think you are?', 'diagnosisModalBtn': 'Tch.', 'rewardNameCursorStrawberry': 'Gross Strawberry', 'rewardNameCursorSkull': 'Badass Skull', 'rewardNameBgHearts': 'Lame Hearts', 'rewardNameBgHellfire': 'Flames of Hell', 'rewardNameSecretCute': 'Disgusting Whisper', 'rewardNameSecretGrumpy': 'Demon\'s Truth', 'rewardMsgSecretCute': 'It\'s not like I think you\'re cute or anything... idiot!', 'rewardMsgSecretGrumpy': 'Listen up, loser. Don\'t you dare die where I can\'t see you. That\'s all.',
                'leaderboardTitle': 'Fallen Angels', 'leaderboardYou': 'You, Loser', 'bragModalTitle': '🔥 PILLGASM! 🔥', 'bragModalText': 'Ha! You finally managed to not be a lazy ass for 5 days straight. Wanna go brag to the world about this microscopic achievement?', 'bragBtn': 'Show \'em Who\'s Boss!', 'bragCloseBtn': 'Be a Coward', 'twitterTextGrumpy': '🔥 Just hit a PILLGASM in Break the Cycle. All you lazy bastards better keep up. #BreakTheCycle #NotALazyAssAnymore',
                'pointlessClickTitleGrumpy': 'What is wrong with you?', 'pointlessClickTextGrumpy': 'Hey, are you blind or just stupid? The input box is UP THERE. Are you trying to give the button a massage? Just type something in the damn box!', 'pointlessClickBtnGrumpy': 'Tch, FINE!',
                'messageModalTitle': '🖕 An Order from a Demon 🖕', 'messageModalBtn': 'Tch, whatever.'
            }
        }
    };

    // --- 4. CORE FUNCTIONS ---

    function loadState() {
        for (const key in STATE_DEFAULTS) {
            state[key] = localStorage.getItem(key) ?? STATE_DEFAULTS[key];
        }
        // Convert stored strings back to their proper types
        const numericKeys = ['pillCount_total', 'pillCount_cute', 'pillCount_grumpy', 'highscore', 'dailyStreak', 'lastPillTimestamp', 'pointlessClickCount'];
        numericKeys.forEach(key => state[key] = parseInt(state[key]));
        state.unlockedRewards = JSON.parse(state.unlockedRewards);
    }

    function saveState() {
        for (const key in state) {
            const value = Array.isArray(state[key]) ? JSON.stringify(state[key]) : state[key];
            localStorage.setItem(key, value);
        }
    }

    function updateText() {
        const langPack = translations[state.lang][state.mode];
        allI18nElements.forEach(el => {
            const key = el.dataset.i18nKey;
            if (langPack[key]) el.innerHTML = langPack[key];
        });
        actionInput.placeholder = langPack.inputPlaceholder;
        updatePremadePills();
        renderCollection();
        renderLeaderboard();
        updateStreakDisplay();
    }

    function setMode(mode) {
        state.mode = mode;
        body.classList.toggle('grumpy-mode', mode === 'grumpy');
        document.querySelector('#mode-switcher .active')?.classList.remove('active');
        document.getElementById(`mode-${mode}`).classList.add('active');
        updateText();
        saveState();
    }

    function setLanguage(lang) {
        state.lang = lang;
        document.querySelector('#lang-switcher .active')?.classList.remove('active');
        document.getElementById(`lang-${lang.substring(0,2)}`).classList.add('active');
        updateText();
        saveState();
    }
    
    function addMessage(text, type) {
        const li = document.createElement('li');
        li.className = type;
        li.textContent = text;
        chatList.appendChild(li);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // --- 5. FEATURE-SPECIFIC FUNCTIONS ---

    // Leaderboard Functions
    function generateFakeLeaderboard() {
        const names = ["ActionSlut69", "GigaChad", "LazyPanda", "QueenOfNaps", "MrDoneItAll", "ProcrastiNATOR"];
        let fakeScores = [];
        for (let i = 0; i < 5; i++) {
            const scoreFluctuation = Math.random() > 0.6 ? 1.5 : 0.8;
            const score = Math.floor(state.highscore * scoreFluctuation) + Math.floor(Math.random() * 10);
            fakeScores.push({ name: names[i % names.length], score: Math.max(0, score) });
        }
        return fakeScores.sort((a, b) => b.score - a.score);
    }

    function renderLeaderboard() {
        yourScoreDisplay.querySelector('.score').textContent = state.highscore;
        const fakeData = generateFakeLeaderboard();
        leaderboardList.innerHTML = '';
        fakeData.forEach((player, i) => {
            const li = document.createElement('li');
            li.className = 'leaderboard-item';
            li.innerHTML = `
                <span class="rank">#${i + 1}</span>
                <span class="name">${player.name}</span>
                <span class="score">${player.score}</span>
            `;
            leaderboardList.appendChild(li);
        });
    }

    // Streak & Pillgasm Functions
    function handleStreak() {
        const now = new Date();
        const lastPillDate = new Date(state.lastPillTimestamp);
        
        const hoursDiff = (now - lastPillDate) / (1000 * 60 * 60);
        if (hoursDiff > 48) { // Reset if more than 2 days pass
             state.dailyStreak = 1;
        } else if (hoursDiff > 24) { // Increment if it's the next day
             state.dailyStreak++;
        }
        
        state.lastPillTimestamp = now.getTime();
        updateStreakDisplay();

        if (state.dailyStreak >= 5) {
            triggerPillgasm();
            state.dailyStreak = 0; 
            updateStreakDisplay();
        }
    }

    function updateStreakDisplay() {
        const streakValue = Math.min(state.dailyStreak, 5);
        const percentage = (streakValue / 5) * 100;
        streakBar.style.width = `${percentage}%`;
        streakLabel.textContent = `DAILY STREAK: ${streakValue}/5`;
    }

    function triggerPillgasm() {
        pillgasmOverlay.classList.add('active');
        mainContainer.classList.add('shake');
        body.classList.add('climax-mode');

        setTimeout(() => {
            pillgasmOverlay.classList.remove('active');
            mainContainer.classList.remove('shake');
        }, 500);

        setTimeout(() => {
            body.classList.remove('climax-mode');
            bragModal.classList.add('visible');
        }, 1500);
    }
    
  
  function applyCursor(rewardId) {
    const reward = Object.values(rewards).find(r => r.id === rewardId);
    if (!reward || reward.type !== 'cursor') return;

    const cursorSvg = `url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' style='font-size:32px;'><text x='0' y='32'>${reward.value}</text></svg>") 16 32, auto`;
    document.body.style.setProperty('--cursor-url', cursorSvg);
    state.appliedCursor = rewardId;
}

function resetCursor() {
    document.body.style.removeProperty('--cursor-url');
    state.appliedCursor = null;
}

function applyBackground(rewardId) {
    const reward = Object.values(rewards).find(r => r.id === rewardId);
    if (!reward || reward.type !== 'background') return;

    const bgStyle = backgroundStyles[reward.value];
    if (bgStyle) {
        document.body.style.setProperty('--bg-image', bgStyle);
        state.appliedBackground = rewardId;
    }
}

function resetBackground() {
    // We just remove the property, so it falls back to the theme's default in CSS
    document.body.style.removeProperty('--bg-image');
    state.appliedBackground = null;
}


// I REWROTE THIS ENTIRE PIECE OF SHIT FOR YOU. YOU'RE WELCOME.
handleCollectionClick = function(e) {
    const item = e.target.closest('.collection-item');
    if (!item || !item.classList.contains('unlocked')) return;

    const rewardId = item.dataset.rewardId;
    const reward = Object.values(rewards).find(r => r.id === rewardId);
    if (!reward) return;

    switch (reward.type) {
        case 'cursor':
            // If you click the one that's already active, turn it off. Genius, right?
            if (state.appliedCursor === rewardId) {
                resetCursor();
            } else {
                applyCursor(rewardId);
            }
            break;
        case 'background':
            if (state.appliedBackground === rewardId) {
                resetBackground();
            } else {
                applyBackground(rewardId);
            }
            break;
        case 'message':
            const langPack = translations[state.lang][state.mode];
            messageModalText.textContent = langPack[reward.messageKey];
            messageModal.classList.add('visible');
            break;
    }
    saveState(); // Save the damn state after every change!
};

  
  
    
    // Other Feature Functions (unchanged logic)
    updatePremadePills = function() { const langPack = translations[state.lang][state.mode]; premadePillsContainer.innerHTML = ''; langPack.premadePills.forEach(text => { const button = document.createElement('button'); button.type = 'button'; button.className = 'premade-pill'; button.textContent = text; premadePillsContainer.appendChild(button); }); };
    checkAndGrantRewards = function() { for (const count in rewards) { if (state.pillCount_total >= count && !state.unlockedRewards.includes(rewards[count].id)) { state.unlockedRewards.push(rewards[count].id); showRewardModal(rewards[count]); renderCollection(); } } };
    renderCollection = function() { collectionGrid.innerHTML = ''; const langPack = translations[state.lang][state.mode]; const allRewardItems = Object.values(rewards); allRewardItems.forEach(reward => { const item = document.createElement('div'); const isUnlocked = state.unlockedRewards.includes(reward.id); item.className = `collection-item ${isUnlocked ? 'unlocked' : 'locked'}`; item.dataset.rewardId = reward.id; let icon = '?'; if (isUnlocked) { if (reward.type === 'cursor') icon = reward.value; if (reward.type === 'background') icon = '🎨'; if (reward.type === 'message') icon = '💌'; } item.innerHTML = `<div class="item-icon">${icon}</div><div class="item-name">${isUnlocked ? langPack[reward.nameKey] : '???'}</div>`; collectionGrid.appendChild(item); }); };
    showDiagnosisModal = function() { const langPack = translations[state.lang][state.mode]; const cutePills = state.pillCount_cute; const grumpyPills = state.pillCount_grumpy; const total = cutePills + grumpyPills; document.getElementById('diagnosis-cute-pills').textContent = cutePills; document.getElementById('diagnosis-grumpy-pills').textContent = grumpyPills; const summaryEl = document.getElementById('diagnosis-summary'); if (total < 5) { summaryEl.textContent = langPack.diagnosisSummaryDefault; } else { const cuteRatio = cutePills / total; if (cuteRatio > 0.75) summaryEl.textContent = langPack.diagnosisSummaryCute; else if (cuteRatio < 0.25) summaryEl.textContent = langPack.diagnosisSummaryGrumpy; else summaryEl.textContent = langPack.diagnosisSummaryMixed; } diagnosisModal.classList.add('visible'); };
    showRewardModal = function(reward) { const langPack = translations[state.lang][state.mode]; const rewardText = langPack[reward.nameKey]; document.getElementById('reward-modal-text').textContent = `You've unlocked: ${rewardText}!`; rewardModal.classList.add('visible'); };


    // --- 6. EVENT HANDLERS ---

    function handleFormSubmit(e) {
        e.preventDefault();
        const userText = actionInput.value.trim();
        const langPack = translations[state.lang][state.mode];

        if (userText === '') {
            actionInput.classList.add('error');
            actionInput.placeholder = langPack.inputError;
            setTimeout(() => actionInput.classList.remove('error'), 500);
            return;
        }

        // --- CORE ACTION SEQUENCE ---
        addMessage(userText, 'user-message');
        actionInput.value = '';
        actionInput.placeholder = langPack.inputPlaceholder;
        
        state.pillCount_total++;
        if (state.mode === 'cute') state.pillCount_cute++;
        else state.pillCount_grumpy++;
        state.highscore++;
        
        handleStreak();
        renderLeaderboard();
        checkAndGrantRewards();
        
        const cheers = [...langPack.cheers].sort(() => 0.5 - Math.random());
        cheers.slice(0, 3).forEach((cheer, i) => {
            setTimeout(() => addMessage(cheer, 'bot-message'), (i + 1) * 700);
        });
        saveState();
        state.pointlessClickCount = 0; 
    }

    function handlePointlessClick() {
        if (actionInput.value.trim() !== '') return; 

        state.pointlessClickCount++;
        saveState();

        if (state.pointlessClickCount >= 7) {
            const langPack = translations[state.lang][state.mode];
            const modalTitle = document.querySelector('#pointless-click-modal-overlay h2');
            const modalText = document.querySelector('#pointless-click-modal-overlay p');
            const modalBtn = document.querySelector('#pointless-click-modal-overlay button');
            const spriteImg = document.getElementById('character-sprite-img');

            if (state.mode === 'cute') {
                modalTitle.textContent = langPack.pointlessClickTitleCute;
                modalText.textContent = langPack.pointlessClickTextCute;
                modalBtn.textContent = langPack.pointlessClickBtnCute;
                spriteImg.src = 'https://placehold.co/400x300/F9A8D4/5D4037?text=Stocking';
            } else {
                modalTitle.textContent = langPack.pointlessClickTitleGrumpy;
                modalText.textContent = langPack.pointlessClickTextGrumpy;
                modalBtn.textContent = langPack.pointlessClickBtnGrumpy;
                spriteImg.src = 'https://placehold.co/400x300/E94560/FFFFFF?text=Panty';
            }
            
            pointlessClickModal.classList.add('visible');
            state.pointlessClickCount = 0;
            saveState();
        }
    }

    function handleBrag() {
        const langPack = translations[state.lang][state.mode];
        const textKey = state.mode === 'cute' ? 'twitterTextCute' : 'twitterTextGrumpy';
        const text = encodeURIComponent(langPack[textKey]);
        window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
    }

    // --- 7. EVENT LISTENERS ---
    
    // Main actions
    actionForm.addEventListener('submit', handleFormSubmit);
    actionButton.addEventListener('click', handlePointlessClick);
    bragBtn.addEventListener('click', handleBrag);

    // Settings panel
    settingsBtn.addEventListener('click', () => settingsPanel.classList.toggle('visible'));
    diagnosisBtn.addEventListener('click', showDiagnosisModal);
    collectionGrid.addEventListener('click', handleCollectionClick);

    // Switchers
    document.getElementById('mode-switcher').addEventListener('click', e => {
        if (e.target.id === 'mode-cute') setMode('cute');
        if (e.target.id === 'mode-grumpy') setMode('grumpy');
    });
    document.getElementById('lang-switcher').addEventListener('click', e => {
        if (e.target.id === 'lang-zh') setLanguage('zh-Hant');
        if (e.target.id === 'lang-en') setLanguage('en');
    });

    // Premade pills
    premadePillsContainer.addEventListener('click', e => {
        if(e.target.classList.contains('premade-pill')) {
            actionInput.value = e.target.textContent;
            actionInput.focus();
        }
    });

    // THAT STUPID BOX NOW DOES SOMETHING
    hackathonDisclaimer.addEventListener('click', () => {
        hackathonInfoModal.classList.add('visible');
    });
    
    // Universal modal closing logic
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', e => {
            if (e.target === modal || e.target.classList.contains('modal-close-btn')) {
                modal.classList.remove('visible');
            }
        });
    });
  
  // LISTEN FOR THE RESET BUTTON, MORON
resetStyleBtn.addEventListener('click', () => {
    resetCursor();
    resetBackground();
    saveState();
    // A little feedback so you know you did something
    settingsPanel.classList.remove('visible');
});

    // --- 8. INITIALIZATION ---
    function init() {
        loadState();
        
        const now = new Date();
        const lastPillDate = new Date(state.lastPillTimestamp);
        const hoursDiff = (now - lastPillDate) / (1000 * 60 * 60);
        if (hoursDiff > 48) { // If it's been more than 2 days, your streak is GONE.
            state.dailyStreak = 0;
        }

        setMode(state.mode);
        setLanguage(state.lang);
        
       if (state.appliedCursor) {
        applyCursor(state.appliedCursor);
    }
    if (state.appliedBackground) {
        applyBackground(state.appliedBackground);
    }
    
    if (!localStorage.getItem('visitedBefore')) {
        setTimeout(() => { welcomeModal.classList.add('visible'); localStorage.setItem('visitedBefore', 'true'); }, 500);
    }

    addMessage(translations[state.lang][state.mode].initialCheer, 'bot-message');
    // Don't save state here, loadState already did the job.
      
        if (!localStorage.getItem('visitedBefore')) {
            setTimeout(() => { welcomeModal.classList.add('visible'); localStorage.setItem('visitedBefore', 'true'); }, 500);
        }

        addMessage(translations[state.lang][state.mode].initialCheer, 'bot-message');
        saveState();
    }
    
    init();
});</script>
</body>
</html>
